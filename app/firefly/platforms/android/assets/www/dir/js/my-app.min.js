var myApp=new Framework7({swipePanel:"left",material:!0,materialRipple:!1,fastClicks:!0,modalCloseByOutside:!0,cache:!1,sortable:!1,swipeout:!1}),$$=Dom7,mainView=myApp.addView(".view-main"),devices=[],deviceReady=!1;null!==localStorage.getItem("ff-devices")?devices=JSON.parse(localStorage.getItem("ff-devices")):localStorage.setItem("ff-devices",JSON.stringify(devices)),document.addEventListener("deviceready",function(){deviceready=!0;var e=function(e){var i=e.notification.payload.additionalData.id,t=e.notification.payload.additionalData.serial;setTimeout(function(){mainView.router.loadPage("views/?id="+i+"?name="+t)},500)};window.plugins.OneSignal.startInit("ec77f744-7135-44ad-ae83-1d6c89d200d2").handleNotificationOpened(e).inFocusDisplaying(window.plugins.OneSignal.OSInFocusDisplayOption.Notification).endInit(),window.plugins.OneSignal.getIds(function(e){console.log("getIds: "+JSON.stringify(e))}),window.plugins.OneSignal.setSubscription(!0),window.plugins.OneSignal.getTags(function(e){console.log("Tags Received: "+JSON.stringify(e))}),sendTags()},!1),myApp.onPageInit("*",function(e){console.log("init "+e.name)}),myApp.onPageInit("index",function(e){mainView.router.loadPage("views/home.html")}).trigger(),myApp.onPageInit("home",function(e){show_devices()}),myApp.onPageInit("device_detail",function(e){var i=e.query.id;$$("#device_serial").html(e.query.name),myApp.showIndicator(),$$.get("http://www.testtmil.sr/firefly/src/public/index.php/api/get_readings/"+i,function(e,i){var e=JSON.parse(e);console.log(e),e.length>0&&$$("#readings").html(""),$$.each(e,function(i,t){var n='<li class="accordion-item"><a href="" class="item-link item-content"><div class="item-inner"><div class="item-title">'+e[i].created+'</div></div></a> <div class="accordion-item-content content-block"><p><strong>GAS-level: </strong>'+e[i].gas_value+"</p><p><strong>FIRE level: </strong>"+e[i].fire_value+"</p><p><strong>FIRE: </strong>"+e[i].fire.toUpperCase()+"</p></div></li>";$$("#readings").append(n)}),myApp.hideIndicator()}),$$("#showState").on("click",function(){var i="http://www.testtmil.sr/firefly/uploads/";myApp.modal({title:"Last taken state",text:'<div class="state-image"><img src="'+i+e.query.name.toLowerCase()+'.jpg"></div></div>',buttons:[{text:"Ok, got it",bold:!0}]})})}),$$("#form-add").submit(function(e){e.preventDefault(),add_device()});var check_devices=function(){device=JSON.parse(localStorage.getItem("ff-devices"))},show_devices=function(){if(check_devices(),devices&&devices.length>0){$$("#devices").html("");for(var e=0;e<devices.length;e++){devices[e];var i='<li><a href="views/device-detail.html?id='+devices[e].id+"&name="+devices[e].serial+'" class="item-link item-content"><div class="item-inner"><div class="item-title">'+devices[e].serial+"</div></div></a></li>";$$("#devices").append(i),$$("#btn-count").html("more")}}},add_device=function(){myApp.showIndicator(),check_devices();var e=myApp.formToJSON("#form-add");check_duplicate(e.name)?($$("#error").show().text("Device already added!"),setTimeout(function(){$$("#error").hide()},1500),myApp.hideIndicator()):$$.post("http://www.testtmil.sr/firefly/src/public/index.php/api/add_device",{name:e.name,password:e.password},function(e){e=JSON.parse(e),devices[devices.length]={id:e[0].id,serial:e[0].serial},localStorage.setItem("ff-devices",JSON.stringify(devices)),clear_popup(),show_devices(),sendTags(),myApp.closeModal(".popup-add"),myApp.hideIndicator()})},clear_popup=function(){$$("#form-add input[name=name], #form-add input[name=password]").val("")},check_duplicate=function(e){for(var i=0;i<devices.length;i++)if(devices[i].serial==e)return!0},sendTags=function(){if(deviceready)for(var e=0;e<devices.length;e++)window.plugins.OneSignal.sendTag("device_"+devices[e].id,"subscribed")};